<?php
// admin/utilisateurs/reinitialiser.php

// Inclure les fichiers nécessaires (connexion à la base de données, fonctions de gestion des utilisateurs)
require_once '../../includes/header.php';
require_once '../../includes/navigation.php';
require_once '../../fonctions/database.php';
require_once '../../fonctions/gestion_utilisateurs.php';

// Vérifier si l'utilisateur est connecté et a les droits d'administrateur (ou la permission de réinitialiser les mots de passe)
// Cette vérification est cruciale pour la sécurité
if (!estAdminConnecte()) { // Vous devrez implémenter cette fonction dans votre système d'authentification
    header('Location: ../index.php');
    exit();
}

// Vérifier si l'ID de l'utilisateur à réinitialiser est présent dans l'URL et est un nombre
if (isset($_GET['id']) && is_numeric($_GET['id'])) {
    $utilisateurId = $_GET['id'];

    // Récupérer les informations de l'utilisateur pour affichage (facultatif, pour confirmation)
    $utilisateur = getUtilisateurParId($pdo, $utilisateurId);
    if (!$utilisateur) {
        $errorMessage = "Utilisateur non trouvé.";
    }
} else {
    $errorMessage = "ID d'utilisateur invalide.";
}

// Traitement du formulaire de réinitialisation
if (isset($_POST['reinitialiser_mot_de_passe'])) {
    // Vérifier le jeton CSRF (important pour la sécurité des formulaires)
    if (!isset($_POST['csrf_token']) || $_POST['csrf_token'] !== $_SESSION['csrf_token']) {
        die("Erreur CSRF.");
    }

    $nouvelleMotDePasse = genererMotDePasseAleatoire(); // Fonction pour générer un mot de passe aléatoire sécurisé
    $motDePasseHache = password_hash($nouvelleMotDePasse, PASSWORD_DEFAULT); // Hacher le nouveau mot de passe

    if (mettreAJourMotDePasse($pdo, $utilisateurId, $motDePasseHache)) {
        $successMessage = "Le mot de passe de l'utilisateur '{$utilisateur['Nom']}' a été réinitialisé avec succès. Le nouveau mot de passe est : <strong>" . htmlspecialchars($nouvelleMotDePasse) . "</strong>. Veuillez communiquer ce mot de passe à l'utilisateur de manière sécurisée.";
        // Vous pourriez également envisager d'envoyer le mot de passe par email (si configuré)
    } else {
        $errorMessage = "Erreur lors de la réinitialisation du mot de passe.";
    }
}

// Générer un jeton CSRF pour la sécurité du formulaire
$_SESSION['csrf_token'] = bin2hex(random_bytes(32));

?>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>BailCompta 360 | Administration - Modifier le rôle</title>
    <link rel="shortcut icon" href="../../images/logo_bailcompta.png" type="image/x-icon">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <link rel="stylesheet" href="../../css/monstyle.css">
    <?php if (isset($admin_style) && $admin_style): ?>
        <link rel="stylesheet" href="../../css/admin_style.css">
    <?php endif; ?>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<?php require_once '../../templates/admin_navigation.php'; // Inclure la navigation spécifique à l'admin ?>
<div class="container mt-5">
    <h2>Réinitialiser le mot de passe d'un utilisateur</h2>

    <?php if (isset($errorMessage)): ?>
        <div class="alert alert-danger"><?= $errorMessage ?></div>
    <?php endif; ?>

    <?php if (isset($successMessage)): ?>
        <div class="alert alert-success"><?= $successMessage ?></div>
    <?php endif; ?>

    <?php if (isset($utilisateur)): ?>
        <p>Êtes-vous sûr de vouloir réinitialiser le mot de passe de l'utilisateur <strong><?= htmlspecialchars($utilisateur['Nom']) ?></strong> (Login: <?= htmlspecialchars($utilisateur['Login']) ?>) ?</p>
        <p class="alert alert-warning"><strong>Attention :</strong> Cette action va générer un nouveau mot de passe aléatoire. Vous devrez communiquer ce nouveau mot de passe à l'utilisateur de manière sécurisée.</p>

        <form method="post">
            <input type="hidden" name="csrf_token" value="<?= $_SESSION['csrf_token'] ?>">
            <button type="submit" name="reinitialiser_mot_de_passe" class="btn btn-warning">
                <span class="glyphicon glyphicon-refresh"></span> Réinitialiser le mot de passe
            </button>
            <a href="index.php" class="btn btn-secondary">
                <span class="glyphicon glyphicon-remove"></span> Annuler
            </a>
        </form>
    <?php elseif (!isset($errorMessage)): ?>
        <p>Veuillez sélectionner un utilisateur depuis la liste pour réinitialiser son mot de passe.</p>
        <a href="index.php" class="btn btn-info">
            <span class="glyphicon glyphicon-arrow-left"></span> Retour à la liste des utilisateurs
        </a>
    <?php endif; ?>
</div>

<?php require_once '../../includes/footer.php'; ?>