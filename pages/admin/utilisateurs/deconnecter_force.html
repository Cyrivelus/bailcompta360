<?php
// admin/utilisateurs/deconnecter_force.php

// Inclure les fichiers nécessaires (connexion à la base de données, fonctions de gestion des utilisateurs, gestion des sessions)
require_once '../../includes/header.php';
require_once '../../includes/navigation.php';
require_once '../../fonctions/database.php';
require_once '../../fonctions/gestion_utilisateurs.php';

// Vérifier si l'utilisateur est connecté et a les droits d'administrateur (ou la permission de déconnecter de force)
if (!estAdminConnecte()) { // Vous devrez implémenter cette fonction dans votre système d'authentification
    header('Location: ../index.php');
    exit();
}

// Vérifier si l'ID de l'utilisateur à déconnecter est présent dans l'URL et est un nombre
if (isset($_GET['id']) && is_numeric($_GET['id'])) {
    $utilisateurIdADeconnecter = $_GET['id'];

    // Récupérer les informations de l'utilisateur pour affichage (facultatif, pour confirmation)
    $utilisateurADeconnecter = getUtilisateurParId($pdo, $utilisateurIdADeconnecter);
    if (!$utilisateurADeconnecter) {
        $errorMessage = "Utilisateur non trouvé.";
    }
} else {
    $errorMessage = "ID d'utilisateur invalide.";
}

// Traitement de la déconnexion forcée
if (isset($_POST['deconnecter_utilisateur'])) {
    // Vérifier le jeton CSRF
    if (!isset($_POST['csrf_token']) || $_POST['csrf_token'] !== $_SESSION['csrf_token']) {
        die("Erreur CSRF.");
    }

    // Tentative de suppression de la session de l'utilisateur
    if (supprimerSessionUtilisateur($pdo, $utilisateurIdADeconnecter)) {
        $successMessage = "L'utilisateur '{$utilisateurADeconnecter['Nom']}' a été déconnecté de force.";
        // Vous pourriez également enregistrer cette action dans un journal d'audit
    } else {
        $errorMessage = "Erreur lors de la tentative de déconnexion forcée de l'utilisateur.";
    }
}

// Générer un jeton CSRF
$_SESSION['csrf_token'] = bin2hex(random_bytes(32));

?>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>BailCompta 360 | Administration - Modifier le rôle</title>
    <link rel="shortcut icon" href="../../images/logo_bailcompta.png" type="image/x-icon">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <link rel="stylesheet" href="../../css/monstyle.css">
    <?php if (isset($admin_style) && $admin_style): ?>
        <link rel="stylesheet" href="../../css/admin_style.css">
    <?php endif; ?>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<?php require_once '../../templates/admin_navigation.php'; // Inclure la navigation spécifique à l'admin ?>

<div class="container mt-5">
    <h2>Déconnecter de force un utilisateur</h2>

    <?php if (isset($errorMessage)): ?>
        <div class="alert alert-danger"><?= $errorMessage ?></div>
    <?php endif; ?>

    <?php if (isset($successMessage)): ?>
        <div class="alert alert-success"><?= $successMessage ?></div>
    <?php endif; ?>

    <?php if (isset($utilisateurADeconnecter)): ?>
        <p>Êtes-vous sûr de vouloir déconnecter de force l'utilisateur <strong><?= htmlspecialchars($utilisateurADeconnecter['Nom']) ?></strong> (Login: <?= htmlspecialchars($utilisateurADeconnecter['Login']) ?>) ?</p>
        <p class="alert alert-warning"><strong>Attention :</strong> Cette action interrompra la session actuelle de l'utilisateur. Utilisez cette fonctionnalité avec précaution.</p>

        <form method="post">
            <input type="hidden" name="csrf_token" value="<?= $_SESSION['csrf_token'] ?>">
            <button type="submit" name="deconnecter_utilisateur" class="btn btn-warning">
                <span class="glyphicon glyphicon-off"></span> Déconnecter l'utilisateur
            </button>
            <a href="index.php" class="btn btn-secondary">
                <span class="glyphicon glyphicon-remove"></span> Annuler
            </a>
        </form>
    <?php elseif (!isset($errorMessage)): ?>
        <p>Veuillez sélectionner un utilisateur depuis la liste pour le déconnecter de force.</p>
        <a href="index.php" class="btn btn-info">
            <span class="glyphicon glyphicon-arrow-left"></span> Retour à la liste des utilisateurs
        </a>
     <?php endif; ?>
</div>

<?php require_once '../../includes/footer.php'; ?>

</body>
</html>

