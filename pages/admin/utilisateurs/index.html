<?php
// pages/admin/utilisateurs/index.php

// Démarrer la session pour la gestion de l'authentification
session_start();

// Vérifier si l'utilisateur est connecté et est un administrateur
if (!isset($_SESSION['utilisateur_id']) || $_SESSION['role'] !== 'Admin') {
    // Rediriger si non autorisé
    header("Location: ../../index.php?error=Accès non autorisé");
    exit();
}

// Inclure l'en-tête de l'administration
$title = "Gestion des Utilisateurs";
include('../includes/header.php');

// Inclure la navigation de l'administration
include('../includes/navigation.php');

// Inclure le fichier de connexion à la base de données
require_once('../../../fonctions/database.php');

// Préparer et exécuter la requête pour récupérer tous les utilisateurs
$sql = "SELECT ID_Utilisateur, Nom, Login_Utilisateur, Role, Derniere_Connexion FROM Utilisateurs";
$stmt = $pdo->prepare($sql);
$stmt->execute();
$utilisateurs = $stmt->fetchAll(PDO::FETCH_ASSOC);
?>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>BailCompta 360 | Administration - Modifier le rôle</title>
    <link rel="shortcut icon" href="../../images/logo_bailcompta.png" type="image/x-icon">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">
    <link rel="stylesheet" href="../../css/monstyle.css">
    <?php if (isset($admin_style) && $admin_style): ?>
        <link rel="stylesheet" href="../../css/admin_style.css">
    <?php endif; ?>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>

<?php require_once '../../templates/admin_navigation.php'; // Inclure la navigation spécifique à l'admin ?>
<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Gestion des Utilisateurs</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="ajouter.php" class="btn btn-sm btn-outline-primary">Ajouter un Utilisateur</a>
            </div>
        </div>
    </div>

    <?php
    // Afficher les messages d'erreur ou de succès s'il y en a
    if (isset($_GET['error'])) {
        echo '<div class="alert alert-danger">' . htmlspecialchars($_GET['error']) . '</div>';
    }
    if (isset($_GET['success'])) {
        echo '<div class="alert alert-success">' . htmlspecialchars($_GET['success']) . '</div>';
    }
    ?>

    <h2>Liste des Utilisateurs</h2>
    <div class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nom</th>
                    <th>Login</th>
                    <th>Rôle</th>
                    <th>Dernière Connexion</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <?php if (empty($utilisateurs)): ?>
                    <tr><td colspan="6">Aucun utilisateur trouvé.</td></tr>
                <?php else: ?>
                    <?php foreach ($utilisateurs as $utilisateur): ?>
                        <tr>
                            <td><?php echo htmlspecialchars($utilisateur['ID_Utilisateur']); ?></td>
                            <td><?php echo htmlspecialchars($utilisateur['Nom']); ?></td>
                            <td><?php echo htmlspecialchars($utilisateur['Login_Utilisateur']); ?></td>
                            <td><?php echo htmlspecialchars($utilisateur['Role']); ?></td>
                            <td><?php echo htmlspecialchars($utilisateur['Derniere_Connexion']); ?></td>
                            <td>
                                <a href="modifier.php?id=<?php echo htmlspecialchars($utilisateur['ID_Utilisateur']); ?>" class="btn btn-sm btn-outline-secondary">Modifier</a>
                                <a href="reinitialiser.php?id=<?php echo htmlspecialchars($utilisateur['ID_Utilisateur']); ?>" class="btn btn-sm btn-outline-secondary">Réinitialiser mot de passe</a>
								<a href="deconnecter_force.php?id=<?php echo htmlspecialchars($utilisateur['ID_Utilisateur']); ?>" class="btn btn-sm btn-outline-warning" onclick="return confirm('Êtes-vous sûr de vouloir déconnecter cet utilisateur ?');">Déconnecter</a>
								<a href="modifier_role.php?id=<?php echo htmlspecialchars($utilisateur['ID_Utilisateur']); ?>" class="btn btn-sm btn-outline-secondary">Rôle</a>
                                <a href="supprimer.php?id=<?php echo htmlspecialchars($utilisateur['ID_Utilisateur']); ?>" class="btn btn-sm btn-outline-danger" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?');">Supprimer</a>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                <?php endif; ?>
            </tbody>
        </table>
    </div>
</main>

<?php
// Inclure le pied de page de l'administration
include('../includes/footer.php');
?>

</body>
</html>